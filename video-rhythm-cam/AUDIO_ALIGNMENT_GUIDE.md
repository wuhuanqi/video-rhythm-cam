# 音频对齐功能使用指南

## 功能介绍

音频对齐功能允许你将一个参考视频中的高质量音频对齐并替换到舞蹈视频中。

### 使用场景

- 你的舞蹈视频背景音质不佳
- 你有一个同一首音乐的参考视频，音质更好
- 你想让舞蹈动作配合更清晰的音频

## 使用方法

### 方法 1: 通过 Web 界面（推荐）

1. **启动服务**
   ```bash
   # 终端 1: 启动 Python API
   cd python-api
   python3 api.py

   # 终端 2: 启动 Web 服务
   cd web
   npm run dev
   ```

2. **打开浏览器**
   - 访问 `http://localhost:3000`
   - 点击"开始使用"进入工作台

3. **上传视频**
   - 首先上传你的舞蹈视频（音质需要改进的那个）
   - 然后切换到"音频对齐"选项卡
   - 上传参考视频（包含同一首音乐的高质量视频）

4. **执行对齐**
   - 点击"对齐音频并合成"按钮
   - 系统会自动：
     - 提取两个视频的音频
     - 计算最佳时间偏移量
     - 对齐音频并合成
     - 自动下载处理后的视频

### 方法 2: 通过命令行

```bash
# 基本用法
python3 scripts/audio_alignment.py <舞蹈视频> <参考视频> -o <输出路径>

# 示例
python3 scripts/audio_alignment.py \
  ../test_dance.mp4 \
  ../reference_video.mp4 \
  -o output_aligned.mp4

# 自定义最大偏移量（默认 5 秒）
python3 scripts/audio_alignment.py \
  dance.mp4 \
  reference.mp4 \
  --max-offset 10.0 \
  -o output.mp4
```

## 技术原理

### 1. 音频提取
- 使用 MoviePy 从视频中提取音频轨道
- 保存为 WAV 格式以保持音质

### 2. 节奏检测
- 使用 librosa 计算节拍强度（onset strength）
- 降采样到 22050 Hz 以提高处理速度

### 3. 偏移计算
- 使用交叉相关（cross-correlation）算法
- 比较两个音频的节拍强度曲线
- 找到最佳匹配的时间偏移量

### 4. 音频对齐
- 正偏移：在参考音频前面添加静音
- 负偏移：裁剪参考音频的开头部分
- 调整音频长度以匹配视频

### 5. 视频合成
- 使用 MoviePy 将对齐后的音频替换到舞蹈视频
- 输出为 MP4 格式（H.264 + AAC）

## 参数说明

### `max_offset`（最大偏移量）
- **默认值**: 5.0 秒
- **说明**: 限制搜索偏移量的范围，提高处理速度
- **调整建议**:
  - 如果视频开始时间相差较大，可以增加这个值
  - 如果确定偏移量很小，可以减小这个值以加快处理

## 工作流程

```
┌─────────────┐
│ 上传舞蹈视频 │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 上传参考视频 │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 提取两个音频 │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 计算时间偏移 │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 对齐音频     │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 合成视频     │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 自动下载     │
└─────────────┘
```

## 常见问题

### Q: 如果两个音频不是同一首歌会怎样？
A: 系统仍然会尝试对齐，但结果可能不准确。建议只对同一首音乐的音频使用此功能。

### Q: 支持哪些视频格式？
A: 支持 MP4、MOV、AVI、MKV、WebM 等常见格式。

### Q: 处理时间需要多久？
A: 取决于视频长度，通常在 10-30 秒左右。

### Q: 音频偏移量是如何计算的？
A: 使用交叉相关算法比较两个音频的节拍强度，找到最相似的偏移位置。

### Q: 可以手动调整偏移量吗？
A: 当前版本自动计算偏移量。如需手动调整，可以使用命令行版本并修改代码。

## API 接口

### POST /api/align-audio

对齐两个视频的音频并合成。

**请求体：**
```json
{
  "danceVideoPath": "/path/to/dance.mp4",
  "referenceVideoPath": "/path/to/reference.mp4",
  "maxOffset": 5.0
}
```

**响应：**
```json
{
  "success": true,
  "outputPath": "/path/to/output_aligned.mp4",
  "offset": 1.234
}
```

## 注意事项

1. 确保两个视频包含同一首音乐
2. 参考视频的音频质量应优于舞蹈视频
3. 处理大文件时可能需要较长时间
4. 输出视频会保存在 `output/` 目录中

## 后续改进

- [ ] 支持手动微调偏移量
- [ ] 添加音频预览功能
- [ ] 支持批量处理多个视频
- [ ] 优化处理速度
- [ ] 支持更多音频格式
